{% extends 'base.html' %}

{% block title %}{{ receita.titulo }} - Saborize{% endblock title %}

{% block content %}

<style>
    /* Estilos para o sistema de estrelas */
    .star {
        font-size: 2em;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
        user-select: none;
        display: inline-block;
    }
    .star:hover { color: #FFD700; }
    .star.filled { color: #FFD700; }
    .rating-display .star { color: #FFD700; cursor: default; }

    /* Imagem da receita no topo do card */
    .receita-img-top {
        width: 100%;
        height: 280px;
        object-fit: cover;
        border-radius: 14px 14px 0 0;
        background: #f2f2f2;
    }
</style>

<div class="container mt-4">

    <!-- Informações da receita -->
    <div class="card card-custom mb-4">

        <!-- IMAGEM NO TOPO DO CARD -->
        {% if receita.imagem %}
            <img src="{{ receita.imagem.url }}" alt="Foto da receita" class="card-img-top receita-img-top">
        {% else %}
            <img src="/static/img/sem_foto.png" alt="Sem foto" class="card-img-top receita-img-top">
        {% endif %}

        <div class="card-body">
            <h1 class="card-title">{{ receita.titulo }}</h1>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <p class="mb-0">
                        <strong>Autor:</strong> {{ receita.user.username }} |
                        <strong>Publicada em:</strong> {{ receita.criada_em|date:"d/m/Y H:i" }}
                    </p>
                </div>
                
                {% if user.is_authenticated and user != receita.user %}
                    <div>
                        <button id="seguir-btn" 
                                class="btn btn-secondary btn-sm fw-bold text-white" 
                                data-user-id="{{ receita.user.id }}" 
                                data-username="{{ receita.user.username }}" 
                                onclick="toggleSeguir(this)">
                            <span id="seguir-texto">Seguir</span>
                        </button>
                    </div>
                {% endif %}
            </div>

            {% if receita.atualizada_em != receita.criada_em %}
                <p><strong>Última atualização:</strong> {{ receita.atualizada_em|date:"d/m/Y H:i" }}</p>
            {% endif %}

            <h5>Descrição:</h5>
            <p>{{ receita.descricao }}</p>

            <h5>Ingredientes:</h5>
            <pre>{{ receita.ingredientes }}</pre>

            <h5>Modo de preparo:</h5>
            <pre>{{ receita.passos }}</pre>
        </div>
    </div>

    <!-- Avaliações -->
    <div class="card card-custom mb-4">
        <div class="card-body">
            <h3>Avaliações</h3>
            {% if receita.total_avaliacoes > 0 %}
                <p><strong>★ {{ receita.media_avaliacoes }}/5</strong> ({{ receita.total_avaliacoes }} avaliação{{ receita.total_avaliacoes|pluralize:"ões" }})</p>
            {% else %}
                <p>Nenhuma avaliação ainda.</p>
            {% endif %}

            {% if user.is_authenticated and user != receita.user %}
                <p><strong>Avalie esta receita:</strong></p>
                <div id="stars-container" class="mb-2">
                    <span class="star" data-rating="1">★</span>
                    <span class="star" data-rating="2">★</span>
                    <span class="star" data-rating="3">★</span>
                    <span class="star" data-rating="4">★</span>
                    <span class="star" data-rating="5">★</span>
                </div>
                <div id="avaliacao-message" class="fw-bold"></div>
            {% elif user == receita.user %}
                <p><em>Você não pode avaliar sua própria receita.</em></p>
            {% else %}
                <p>
                    <a href="{% url 'paginaLogin' %}?next={{ request.get_full_path }}">Faça login</a> 
                    para avaliar esta receita.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Comentários -->
    <div class="card card-custom mb-4">
        <div class="card-body">
            <h3>Comentários ({{ total_comentarios }})</h3>

            {% if user.is_authenticated %}
                <a href="{% url 'fazer_comentario' receita.id %}" class="btn btn-custom mb-3">Comentar nesta receita</a>
            {% else %}
                <p>
                    <strong>Quer comentar?</strong>
                    <a href="{% url 'paginaLogin' %}?next={{ request.get_full_path }}">Faça login</a>
                    ou 
                    <a href="{% url 'registrarUser' %}?next={{ request.get_full_path }}">registre-se</a>
                    para participar da conversa!
                </p>
            {% endif %}

            {% for comentario in comentarios %}
                <div class="border p-2 mb-2 rounded d-flex align-items-start gap-2">

                    <!-- FOTO DO USUARIO -->
                    <img src="{% if comentario.usuario.foto_perfil %}{{ comentario.usuario.foto_perfil.url }}{% else %}/static/img/default_profile.png{% endif %}"
                         class="rounded-circle"
                         width="45"
                         height="45"
                         style="object-fit: cover;">

                    <div>
                        <div>
                            <strong>{{ comentario.usuario.username }}</strong> -
                            {{ comentario.criado_em|date:"d/m/Y H:i" }}
                            {% if comentario.atualizado_em != comentario.criado_em %}
                                <em>(editado em {{ comentario.atualizado_em|date:"d/m/Y H:i" }})</em>
                            {% endif %}
                        </div>
                        <div>{{ comentario.texto }}</div>
                    </div>

                </div>
            {% empty %}
                <p>Nenhum comentário ainda.</p>
            {% endfor %}
        </div>
    </div>

</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    let isFollowing = false;

    function verificarSeguindo() {
        atualizarBotaoSeguir(false);
    }

    function atualizarBotaoSeguir(seguindo) {
        const btn = document.getElementById('seguir-btn');
        const texto = document.getElementById('seguir-texto');
        if (btn && texto) {
            isFollowing = seguindo;
            if (seguindo) {
                btn.className = 'btn btn-warning btn-sm fw-bold text-dark';
                texto.textContent = 'Seguindo';
            } else {
                btn.className = 'btn btn-secondary btn-sm fw-bold text-white';
                texto.textContent = 'Seguir';
            }
        }
    }

    function toggleSeguir(button) {
        const userId = button.getAttribute('data-user-id');
        const url = isFollowing ? `/receitas/api/parar-seguir/${userId}/` : `/receitas/api/seguir/${userId}/`;
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                atualizarBotaoSeguir(data.action === 'seguindo');
            }
        })
        .catch(error => console.error('Erro:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
        verificarSeguindo();
        
        // Inicializar sistema de avaliação
        {% if user.is_authenticated and user != receita.user %}
        initRatingSystem();
        carregarAvaliacaoUsuario();
        {% endif %}
    });

    // Sistema de Avaliação
    {% if user.is_authenticated and user != receita.user %}
    let userRating = 0;

    function initRatingSystem() {
        const stars = document.querySelectorAll('#stars-container .star');
        
        stars.forEach(star => {
            // Hover effect
            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                highlightStars(rating);
            });
            
            // Click event
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                avaliarReceita(rating);
            });
        });
        
        // Reset stars on container leave
        const container = document.getElementById('stars-container');
        container.addEventListener('mouseleave', function() {
            highlightStars(userRating);
        });
    }

    function highlightStars(rating) {
        const stars = document.querySelectorAll('#stars-container .star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('filled');
            } else {
                star.classList.remove('filled');
            }
        });
    }

    function carregarAvaliacaoUsuario() {
        fetch(`/receitas/api/avaliacoes/{{ receita.id }}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user_avaliacao && data.user_avaliacao.nota) {
                    userRating = data.user_avaliacao.nota;
                    highlightStars(userRating);
                    document.getElementById('avaliacao-message').innerHTML = 
                        `<span class="text-success">Você avaliou com ${userRating} estrelas</span>`;
                }
            })
            .catch(error => console.error('Erro ao carregar avaliação:', error));
    }

    function avaliarReceita(nota) {
        const messageDiv = document.getElementById('avaliacao-message');
        
        fetch(`/receitas/api/avaliacao/criar/{{ receita.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ nota: nota })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userRating = nota;
                highlightStars(nota);
                
                // Atualizar a exibição da média
                const mediaElement = document.querySelector('.card-custom p strong');
                if (mediaElement) {
                    mediaElement.parentElement.innerHTML = 
                        `<strong>★ ${data.receita_stats.media_avaliacoes}/5</strong> ` +
                        `(${data.receita_stats.total_avaliacoes} avaliação${data.receita_stats.total_avaliacoes > 1 ? 'ões' : ''})`;
                }
                
                messageDiv.innerHTML = `<span class="text-success">${data.message}</span>`;
                
                setTimeout(() => {
                    messageDiv.innerHTML = `<span class="text-success">Você avaliou com ${nota} estrelas</span>`;
                }, 3000);
            } else {
                messageDiv.innerHTML = `<span class="text-danger">${data.error}</span>`;
            }
        })
        .catch(error => {
            console.error('Erro ao avaliar:', error);
            messageDiv.innerHTML = '<span class="text-danger">Erro ao enviar avaliação</span>';
        });
    }
    {% endif %}
</script>

{% endblock content %}
